<!doctype html><html class=no-js lang=es>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Primeros pasos con nodemcu y micropython en linux - Sherblog</title>
<script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script>
<meta name=description content="No es una guía, simplemente mi experiencia como primera toma de contacto con microcontroladores esp8266 y esp32 a través de nodemcu y micropython en linux mint.">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="http://www.sherblog.pro//images/20210304_nodemcu_micropython_00.jpg">
<meta name=twitter:title content="Primeros pasos con nodemcu y micropython en linux">
<meta name=twitter:description content="No es una guía, simplemente mi experiencia como primera toma de contacto con microcontroladores esp8266 y esp32 a través de nodemcu y micropython en linux mint.">
<meta name=twitter:creator content="@sherblogpro">
<meta name=twitter:site content="sherblog.pro">
<link rel=dns-prefetch href=//fonts.googleapis.com>
<link rel=dns-prefetch href=//fonts.gstatic.com>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/custom.css>
<link rel="shortcut icon" href=/favicon.ico>
</head>
<body class=body>
<div class="container container--outer">
<header class=header>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Primeros pasos con nodemcu y micropython en linux">
<meta name=twitter:description content="No es una guía, simplemente mi experiencia como primera toma de contacto con microcontroladores esp8266 y esp32 a través de nodemcu y micropython en linux mint.">
<div class=container>
<div class=logo>
<a class=logo__link href=/ title=Sherblog rel=home>
<div class=logo__title>Sherblog</div>
<div class=logo__tagline>Sólo mi forma de hacer las cosas...</div>
</a>
</div>
<nav class=menu>
<button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menú</span>
</button>
<ul class=menu__list>
<li class=menu__item>
<a class=menu__link href=/post/computing/hugo/>
<span class=menu__text>Hugo</span>
</a>
</li>
<li class=menu__item>
<a class=menu__link href=/mis-v%C3%A9rtices-geod%C3%A9sicos/>
<span class=menu__text>Mis vértices geodésicos</span>
</a>
</li>
<li class=menu__item>
<a class=menu__link href=/post/computing/raspberry/>
<span class=menu__text>Raspberry Pi desde cero</span>
</a>
</li>
<li class=menu__item>
<a class=menu__link href=/post/android/tasker/>
<span class=menu__text>Tasker</span>
</a>
</li>
</ul>
</nav>
</div>
</header>
<div class="wrapper flex">
<div class=primary>
<main class=main role=main>
<article class=post>
<header class=post__header>
<h1 class=post__title>Primeros pasos con nodemcu y micropython en linux</h1>
<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-02-16T00:00:00Z>2021-02-16</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/computing/ rel=category>computing</a>, <a class=meta__link href=/categories/iot/ rel=category>iot</a>
</span>
</div></div>
</header>
<figure class=post__thumbnail>
<img src=/images/20210304_nodemcu_micropython_00.jpg alt="Primeros pasos con nodemcu y micropython en linux">
</figure><div class="content post__content clearfix">
<p>Aquí dejo lo que ha sido mi salto desde la raspberry pi y python hacia el esp8266 y micropython mediante la placa node mcu y el objetivo de una sonda de temperatura con comunicación wifi.</p>
<p>Este ha sido mi arranque en el mundo de los microcontroladores dl que sólo toqué hace unos años un poco el arduino y que abandoné por falta de proyectos.</p>
<h3 id=lo-que-necesitamos>Lo que necesitamos</h3>
<p>Aunque no es la opción más pequeña ni más barata creo que es la forma más sencilla de empezar en el mundo de los microcontroladores ya que la lista de necesidades es realmente pequeña</p>
<ul>
<li>Placa <a href=https://www.nodemcu.com>nodemcu</a></li>
<li>Cable microusb de datos</li>
<li>Un pc</li>
<li>Tiempo</li>
</ul>
<p>Si estás leyendo esto que tengas cable, pc y tiempo por lo que solo son necesarios unos poco euros para conseguir la placa.</p>
<p><img src=/images/20210304_nodemcu_micropython_01.jpg alt=image-01></p>
<h3 id=micropython-y-thonny>Micropython y Thonny</h3>
<p>Si hubiera llegado aquí desde el mundo de arduino quizas ahora estaría empleando su entorno de desarrollo para programar el nodemcu en c++. Como vengo de la Raspberry voy a introducirme en el mundo de <a href=https://micropython.org>micropython</a> mediante <a href=https://thonny.org>Thonny</a>.</p>
<p>Para la instalación de <a href=https://thonny.org>Thonny</a> nos bastará con</p>
<pre tabindex=0><code>sudo apt install python3 python3-pip python3-tk
sudo pip3 install thonny
</code></pre><p>Para arrancar el entorno de programación <a href=https://thonny.org>Thonny</a> abriremos una consola de comandos y ejecutaremos <code>thonny</code></p>
<p><img src=/images/20210304_nodemcu_micropython_02.jpg alt=image-02></p>
<h3 id=instalando-el-firmware>Instalando el firmware</h3>
<p>En la web de <a href=https://micropython.org>micropython</a> hay una detallada <a href=http://docs.micropython.org/en/latest/esp8266/tutorial/intro.html#deploying-the-firmware>guía de instalación del firmware</a> que se resume en:</p>
<ul>
<li>Instalar esptool <code>pip install esptool</code></li>
<li>Descargar el ultimo <a href=http://micropython.org/download/esp8266/>firmware</a> estable</li>
<li>Borrar la memoria <code>esptool.py --port /dev/ttyUSB0 erase_flash</code></li>
<li>Cargar el firmware en la placa mediante el siguiente comando</li>
</ul>
<pre tabindex=0><code>esptool.py --port /dev/ttyUSB0 --baud 460800 write_flash --flash_size=detect 0 esp8266-20200911-v1.13.bin
</code></pre><p>Dentro del entorno de <a href=https://thonny.org>Thonny</a>, en el menú &ldquo;Herramientas-Opciones&rdquo; y la pestaña &ldquo;Intérprete&rdquo; nos ofrece la opción de instalar o actualizar el firmware. Para hacerlo sólo hay que selecciónar en dispositivo y el puerto, este último en caso de que no sea capaz de detectarlo automáticamente.</p>
<p><img src=/images/20210304_nodemcu_micropython_03.jpg alt=image-03></p>
<blockquote>
<p>Aunque no lo he probado, supongo que en caso de que no hayas instalado esptool de forma manual, al inatalar <a href=https://thonny.org>Thonny</a> comprobará las dependencias y lo instalará si es necesario.</p>
</blockquote>
<p>Después de esto, si la instalación ha sido correcta, en la consola de comandos podremos escribir `print(&ldquo;hola mundo&rdquo;) y obtener respuesta como se muestra en la imagen.</p>
<p><img src=/images/20210304_nodemcu_micropython_04.jpg alt=image-04></p>
<h3 id=el-montaje>El montaje</h3>
<p>Como primer montaje quiero realizar una simple medición de temperatura mediante una AM2302 que tan buenos resultados me está dando en la raspberry. El sensor lleva tres cables, el de alimentación, el de masa y la señal. aunque no lo tengo muy claro si es necesaria o no debido a la configuración interna del nodemcu, se recomienda unir la alimentación y la masa con una resistencia de 10K tal y como se muestra en la imagen.</p>
<p><img src=/images/20210304_nodemcu_micropython_05.jpg alt=image-05></p>
<blockquote>
<p>Un detalle importante es que, aunque el cable de señal está conectado a la patilla D2 de la placa, esta se corresponde la GPIO4 del ESP8266 interno para la futura programacion del microcontrolador.</p>
</blockquote>
<p><img src=/images/20210304_nodemcu_micropython_06.jpg alt=image-06></p>
<h3 id=programación>Programación</h3>
<p>Con la placa conectada al usb del ordenador es el momento de abrir Thonny y en el menú &ldquo;ejecutar&rdquo; seleccionar el intérprete correspondiente a Micropython y el puerto correspondiente al que está conectado la placa tal y como se puede ver en la siguiente imagen.</p>
<p><img src=/images/20210304_nodemcu_micropython_07.jpg alt=image-07></p>
<p>Pulsaremos Ctrl + F2 para que en la consola inferior aparezca el propmt de micropython</p>
<p><img src=/images/20210304_nodemcu_micropython_08.jpg alt=image-08></p>
<blockquote>
<p>En algunas ocasiones da un error al detener y reinicializar el Back-end por que la placa está ocupada, en estos casos pulsando varias veces seguidas Ctrl+F2 desaparece el error.</p>
</blockquote>
<p>Crearemos un documento main.py que se ejecutará al arrancar el microcontrolador y que tendrá las siguientes funciones.</p>
<ul>
<li>Contactarse a la red wifi</li>
<li>Contactarse al servidor MQTT</li>
<li>Captar la temperatura de la sonda</li>
<li>Enviar un mensaje con la temperatura</li>
<li>Esperar 30 segundos</li>
<li>Volver a captar, enviar y esperar</li>
</ul>
<p>Y así de forma indefinida añadiendo una capacidad de reconexión a la red wifi o servidor MQTT cuando alguno de los dos falle.</p>
<pre tabindex=0><code>import machine
from machine import Pin
from time import sleep
import dht 
from etc.umqttsimple import MQTTClient
import ubinascii

import network

# Conexión al wifi
ssid = 'nombre_de_la_red'
password = 'contraseña'

station = network.WLAN(network.STA_IF)
station.active(True)
station.connect(ssid, password)

while station.isconnected() == False:
  pass

print('Wifi connection successful')

# Configuración mqtt
mqtt_server = '192.168.1.203'
client_id = ubinascii.hexlify(machine.unique_id())
topic_pub_temp = b'temp_humidity'

def connect_mqtt():
  global client_id, mqtt_server
  client = MQTTClient(client_id, mqtt_server)
  client.connect()
  print('Connected to %s MQTT broker' % (mqtt_server))
  return client

def restart_and_reconnect():
  print('Failed to connect to MQTT broker. Reconnecting...')
  sleep(10)
  machine.reset()
  
try:
  client = connect_mqtt()
except OSError as e:
  restart_and_reconnect()
  
# Captura de datos del AM2302 En el GIO4 (Pin D2)
sensor = dht.DHT22(machine.Pin(4))

def read_sensor():
  try:
    sleep(2)
    sensor.measure()
    temp = sensor.temperature()
    hum = sensor.humidity()
    print('Temperatura: %.1f C' %temp)
    print('Humedad: %.0f %%' %hum)
    msg = (b'{0:.1f},{1:.0f}'.format(temp, hum))
    return msg
  except OSError as e:
    print(&quot;error&quot;)
    machine.reset()
    msg = (b'{0:3.1f},{1:3.1f}'.format(0, 0))
    return msg


# Bucle principal
while True:
  try:
    client.publish(topic_pub_temp, read_sensor())
  except OSError as e:
    restart_and_reconnect()
    
  sleep(30)
</code></pre><p>El <a href=https://github.com/sherlockes/SherloScripts/blob/master/upython/nodemcu_esp8266_am2302_wifi_mqtt_main.py>archivo</a> lo puedes encontrar en mi repositorio de GitHub con la última versión actualizada. Para la comunicación mqtt hago uso de la clase &ldquo;<a href=https://github.com/RuiSantosdotme/ESP-MicroPython/blob/master/code/MQTT/umqttsimple.py>umqttsimple</a>&rdquo; que hay se guardar dentor de la carpeta &ldquo;etc&rdquo;.</p>
<h3 id=links-de-interés>Links de interés</h3>
<p><a href=https://randomnerdtutorials.com/esp32-esp8266-dht11-dht22-micropython-temperature-humidity-sensor/>https://randomnerdtutorials.com/esp32-esp8266-dht11-dht22-micropython-temperature-humidity-sensor/</a>
<a href=https://devonhubner.org/MicroPython_on_NodeMCU_with_dht11_button_and_led/>https://devonhubner.org/MicroPython_on_NodeMCU_with_dht11_button_and_led/</a>
<a href=https://techtutorialsx.com/2017/06/06/esp32-esp8266-micropython-automatic-connection-to-wifi/>https://techtutorialsx.com/2017/06/06/esp32-esp8266-micropython-automatic-connection-to-wifi/</a>
<a href=https://www.rototron.info/raspberry-pi-esp32-micropython-mqtt-dht22-tutorial/>https://www.rototron.info/raspberry-pi-esp32-micropython-mqtt-dht22-tutorial/</a></p>
</div>
<footer class=post__footer>
<div class="content post__content clearfix">
<h3>Otros de mís artículos que te pueden interesar</h3>
<ul>
<li><a href=/actualizar-m%C3%B3dulo-de-funciones-en-excel/>Actualizar módulo de funciones en excel</a></li>
<li><a href=/cerrar-buffers-abiertos-en-emacs-con-ibuffer/>Cerrar buffers abiertos en Emacs con ibuffer</a></li>
<li><a href=/clonar-el-disco-de-arranque-de-la-raspberry/>Clonar el disco de arranque de la raspberry</a></li>
<li><a href=/synology-no-actualiza-por-el-espacio-de-la-partici%C3%B3n-del-sistema/>Synology no actualiza por el espacio de la partición del sistema</a></li>
<li><a href=/apagar-todas-las-luces-en-home-assistant/>Apagar todas las luces en Home Assistant</a></li>
</ul>
</div>
<div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg>
<ul class=tags__list>
<li class=tags__item>
<a class="tags__link btn" href=/tags/micropython/ rel=tag>micropython</a>
</li>
</ul>
</div>
</footer>
</article>
</main>
<nav class="post-nav flex">
<div class="post-nav__item post-nav__item--prev">
<a class=post-nav__link href=/descargar-archivos-de-telegram/ rel=prev><span class=post-nav__caption>«&#8201;Anterior</span><p class=post-nav__post-title>Descargar archivos de Telegram</p></a>
</div>
<div class="post-nav__item post-nav__item--next">
<a class=post-nav__link href=/trabajar-con-ssh-key-en-synology/ rel=next><span class=post-nav__caption>Siguiente&#8201;»</span><p class=post-nav__post-title>Trabajar con ssh-key en Synology</p></a>
</div>
</nav>
</div>
</div>
<footer class=footer>
<div class="container footer__container flex">
<div class=footer__copyright>
&copy; 2022 Sherblog.
<span class=footer__copyright-credits>Generado con <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> y <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a>.</span>
</div>
</div>
</footer>
</div>
<script async defer src=/js/menu.js></script>
<script src=/js/custom.js></script></body>
</html>